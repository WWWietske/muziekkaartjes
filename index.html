<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Spotify Kaartjes Generator (JS)</title>
    <!-- PDFKit (voor PDF-generatie) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfkit/0.12.3/pdfkit.standalone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Blob.js/2.0.0/Blob.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- QRCode.js -->
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        #credentials {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        input, button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            box-sizing: border-box;
        }
        button {
            background: #1DB954;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        #loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        #output {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .card-preview {
            display: inline-block;
            width: 200px;
            height: 120px;
            margin: 10px;
            background: #eee;
            position: relative;
            overflow: hidden;
        }
        .hidden { display: none; }
        .progress-bar {
            height: 5px;
            background: #1DB954;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <h1>üéµ Spotify Playlist Kaartjes (Pure JS)</h1>
    <p>Genereer PDF-kaartjes van je Spotify-playlist. <strong>Je credentials blijven lokaal!</strong></p>

    <div id="credentials">
        <input type="text" id="clientId" placeholder="Spotify Client ID" required>
        <input type="password" id="clientSecret" placeholder="Spotify Client Secret" required>
        <input type="text" id="playlistUrl" placeholder="Playlist URL"
               value="https://open.spotify.com/playlist/37i9dQZF1DX4SBhb3fqCJd">
        <button onclick="generateCards()">Genereer Kaartjes</button>
    </div>

    <div id="loading" class="hidden">
        <div class="progress-bar"></div>
        <p>‚è≥ Bezig met ophalen playlist...</p>
    </div>

    <div id="output" class="hidden">
        <h2>‚úÖ Kaartjes gegenereerd!</h2>
        <div id="preview"></div>
        <button id="downloadPdf" style="background: #1DB954; color: white; border: none; padding: 10px; margin-top: 10px;">
            üì• Download PDF
        </button>
    </div>

    <script>
        // Achtergrondkleuren voor kaartjes
        const backgroundColors = [
            'rgba(255, 200, 200, 0.8)', 'rgba(255, 220, 200, 0.8)',
            'rgba(255, 255, 200, 0.8)', 'rgba(200, 255, 200, 0.8)',
            'rgba(200, 255, 255, 0.8)', 'rgba(200, 220, 255, 0.8)',
            'rgba(220, 200, 255, 0.8)', 'rgba(255, 200, 220, 0.8)'
        ];

        // Haal Spotify access token op
        async function getSpotifyToken(clientId, clientSecret) {
            const response = await fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': 'Basic ' + btoa(clientId + ':' + clientSecret)
                },
                body: 'grant_type=client_credentials'
            });
            const data = await response.json();
            return data.access_token;
        }

        // Haal playlist-data op
        async function fetchPlaylistData(token, playlistUrl) {
            const playlistId = playlistUrl.split('/').pop().split('?')[0];
            const response = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}`, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            return await response.json();
        }

        // Genereer een QR-code als data URL
        function generateQRCode(url) {
            return new Promise((resolve) => {
                const qrCode = new QRCode({
                    text: url,
                    width: 100,
                    height: 100,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                });
                resolve(qrCode.toDataURL());
            });
        }

        // Genereer PDF met PDFKit
        function generatePDF(tracks) {
            return new Promise((resolve) => {
                const doc = new PDFDocument({ size: 'A4' });
                const buffers = [];
                doc.on('data', buffers.push.bind(buffers));
                doc.on('end', () => {
                    const pdfBlob = new Blob(buffers, { type: 'application/pdf' });
                    resolve(pdfBlob);
                });

                // 2 kolommen, 3 rijen per pagina
                const cardWidth = 180;
                const cardHeight = 100;
                const margin = 30;
                const cols = 2;
                const rows = 3;
                const cardsPerPage = cols * rows;

                tracks.forEach((track, index) => {
                    const pageNum = Math.floor(index / cardsPerPage);
                    const col = index % cols;
                    const row = Math.floor((index % cardsPerPage) / cols);

                    // Nieuwe pagina beginnen
                    if (index % cardsPerPage === 0 && index > 0) {
                        doc.addPage();
                    }

                    // Kaartje tekenen
                    const x = margin + col * (cardWidth + 20);
                    const y = margin + row * (cardHeight + 20);

                    // Achtergrond
                    doc.rect(x, y, cardWidth, cardHeight)
                       .fillAndStroke(track.color, '#ccc');

                    // Tekst
                    doc.fillColor('#000')
                       .fontSize(10)
                       .text(track.artist, x + 10, y + cardHeight - 20, { width: cardWidth - 20 });

                    doc.fontSize(12)
                       .text(track.title, x + 10, y + cardHeight - 40, { width: cardWidth - 20 });

                    doc.fontSize(24)
                       .text(track.year, x + 10, y + cardHeight - 70);
                });

                doc.end();
            });
        }

        // Toon preview van kaartjes
        function showPreview(tracks) {
            const previewContainer = document.getElementById('preview');
            previewContainer.innerHTML = '';

            tracks.slice(0, 6).forEach((track, index) => {
                const card = document.createElement('div');
                card.className = 'card-preview';
                card.style.backgroundColor = track.color;

                const title = document.createElement('div');
                title.textContent = track.title;
                title.style.fontWeight = 'bold';
                title.style.fontSize = '12px';
                title.style.margin = '5px';
                title.style.color = '#000';

                const artist = document.createElement('div');
                artist.textContent = track.artist;
                artist.style.fontSize = '10px';
                artist.style.margin = '5px';
                artist.style.color = '#000';

                const year = document.createElement('div');
                year.textContent = track.year;
                year.style.fontSize = '20px';
                year.style.margin = '5px';
                year.style.color = '#000';

                card.appendChild(title);
                card.appendChild(artist);
                card.appendChild(year);
                previewContainer.appendChild(card);
            });
        }

        // Hoofd functie
        async function generateCards() {
            const clientId = document.getElementById('clientId').value;
            const clientSecret = document.getElementById('clientSecret').value;
            const playlistUrl = document.getElementById('playlistUrl').value;

            if (!clientId || !clientSecret || !playlistUrl) {
                alert('Vul alle velden in!');
                return;
            }

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('output').classList.add('hidden');
            document.querySelector('.progress-bar').style.width = '10%';

            try {
                // 1. Haal Spotify token op
                document.querySelector('.progress-bar').style.width = '20%';
                const token = await getSpotifyToken(clientId, clientSecret);

                // 2. Haal playlist data op
                document.querySelector('.progress-bar').style.width = '40%';
                const playlistData = await fetchPlaylistData(token, playlistUrl);

                // 3. Verwerk tracks
                document.querySelector('.progress-bar').style.width = '60%';
                const tracks = playlistData.tracks.items
                    .filter(item => item.track)
                    .map((item, index) => {
                        const track = item.track;
                        return {
                            title: track.name,
                            artist: track.artists.map(a => a.name).join(', '),
                            year: track.album.release_date?.split('-')[0] || 'Onbekend',
                            url: track.external_urls.spotify,
                            color: backgroundColors[index % backgroundColors.length]
                        };
                    });

                // 4. Toon preview
                document.querySelector('.progress-bar').style.width = '80%';
                showPreview(tracks);

                // 5. Genereer PDF
                document.querySelector('.progress-bar').style.width = '90%';
                const pdfBlob = await generatePDF(tracks);

                // 6. Toon download knop
                document.querySelector('.progress-bar').style.width = '100%';
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('output').classList.remove('hidden');

                // Voeg download functionaliteit toe
                document.getElementById('downloadPdf').onclick = () => {
                    saveAs(pdfBlob, 'spotify_kaartjes.pdf');
                };

            } catch (error) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('output').innerHTML = `
                    <h2 style="color: red;">‚ùå Fout!</h2>
                    <p>${error.message}</p>
                    <p>Controleer je Spotify API credentials en playlist URL.</p>
                `;
                document.getElementById('output').classList.remove('hidden');
                console.error(error);
            }
        }
    </script>
</body>
</html>
